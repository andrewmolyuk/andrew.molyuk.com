---
title: 'Структура микросервисного проекта на Go'
date: 2023-06-02T13:22:51+03:00
tags: ['golang', 'структура проекта', 'микросервисы']
draft: false
---

В Go я пришел около года назад. Я пишу на нем в свободное время и мне нравится. Я думаю, что это очень хороший язык как
для новичков в IT, так и для тех кто уже имеет опыт в программировании. На сегодняшний день я использую Go в своих
личных проектах и в профессиональной работе.

<!--more-->

После года использования языка в продакшн я могу с уверенностью сказать, что Go показал себя только с лучшей стороны.
Имея в команде в основном Javascript-разработчиков у меня не возникало никаких сложностей для введения их в курс дела.
Читабельность и простота языка позволяет быстро разобраться в коде. Но я бы не сказал, что Go - это простой язык.

За это время я написал несколько микросервисных проектов на Go. Все они были разного размера и сложности, но в каждом
из них я старался использовать похожие подходы к структуре проекта. Постепенно я пришел к структуре, которая мне
нравится. Я не утверждаю, что это лучшая структура микросервисного проекта, но она работает для меня. Я надеюсь, что
она вам тоже понравится.

Кроме того я хочу отметить, что я не являюсь экспертом в Go. Я просто делюсь своим опытом. Если вы заметите какие-то
ошибки или у вас есть предложения по улучшению, то не сдерживайте себя и напишите мне об этом.

## Структура проекта

За основу я взял идеи из Clean Architecture и в симбиозе с базовыми рекомендациями, после нескольких итераций,
получилась следующая
структура проекта:

```shell
.
├── deploy
├── pkg
│   ├── config
│   ├── grpc
│   ├── log
│   ├── mongodb
│   └── types
├── services
│   └── service1
│       ├── app
│       │   ├── grpc
│       │   └── http
│       ├── business
│       │   ├── core
│       │   ├── data
│       │   └── system
│       └── deploy
├── tools
└── web
    ├── deploy
    ├── public
    ├── node_modules
    ├── static
    └── src
```

А теперь давайте разберемся поподробнее что это за папки и какие в них файлы.

### deploy

В этой папке хранятся файлы необходимые для деплоя проекта. В зависимости от величины проекта и необходимой
инфраструктуры деплой может быть централизованным или специфическим для каждого из сервисов. Здесь также могут
находиться файлы для деплоя общих подсистем. Это самое правильное место для файлов Kubernetes или Docker Compose. В
большинстве случаев я использую Docker Compose для локальной разработки и Docker Swarm для деплоя в продакшн.

### pkg

В этой папке хранятся все локальные пакеты, которые используются в проекте. Я не использую внешние пакеты внутри
папки `pkg`. Все внешние пакеты хранятся в папке `vendor`. Все пакеты внутри папки `pkg` должны быть независимыми и не
должны иметь зависимостей на пакеты вне этой папки. Это позволяет легко переиспользовать пакеты в других проектах. Если
пакет можно вынести в отдельный репозиторий, но он пока не дорос до этого и нужен только в рамках этого проекта - можете
смело класть его сюда.

Можно закрыть пакеты папкой `internal`, но я не вижу в этом смысла так как это только загромождает проект.

В структуре проекта выше я привел для примера несколько пакетов, которые я использую в своих проектах. Давайте быстро
разберемся с ними.

- config - пакет для работы с конфигурацией. Я иногда использую оболочку над [viper](https://github.com/spf13/viper) или
  же что-то небольшое и самописное в зависимости от проекта.
- grpc - пакет для работы с gRPC. Я использую [grpc-go](https://grpc.io/docs/languages/go/quickstart/) и
  [grpc-gateway](https://grpc-ecosystem.github.io/grpc-gateway/). В этом пакете я храню все необходимые для работы с
  gRPC и gRPC-gateway файлы.
- log - пакет для работы с логами. Как правило, я использую [zap](https://pkg.go.dev/go.uber.org/zap) от Убера. Это
  очень быстрый и удобный пакет для работы с логами.
- mongodb - пакет для работы с MongoDB. Я использую [mongo-go-driver](https://github.com/mongodb/mongo-go-driver).
- types - пакет для хранения общих типов. Я использую его для хранения общих типов данных, которые используются в
  разных частях проекта. Как правило, я стараюсь переопределять типы из внешних пакетов в этом пакете. Это позволяет не
  создавать зависимости на внешние пакеты внутри домена проекта.

Все вышеуказанные пакеты внутри папки `pkg` определены для примера и могут быть изменены в зависимости от проекта.

### services

Самый важный каталог в проекте. Здесь хранятся все сервисы проекта. Каждый сервис имеет свою папку, а внутри нее уже все
необходимые файлы. В этой же папке находится файл `main.go`, который является точкой входа в приложение. В этом файле я
стараюсь держать минимально необходимое для запуска количество кода, включая инициализацию зависимостей и запуск
сервера.

Внутри папки сервиса есть три папки: `app`, `business` и `deploy`. Давайте разберемся с каждой из них.

#### service/app

В этой папке хранятся файлы, которые относятся к внешнему интерфейсу приложению. В моем примере внутри этой папки есть
две папки: `grpc` и `http`. В них хранятся файлы, которые относятся к gRPC и HTTP соответственно. Внутри этих папок
могут быть файлы с обработчиками запросов, файлы с мидлварами, файлы с валидаторами внешних данных и т.д. В конечном
счете в этой папке должны быть только файлы, которые относятся к внешнему интерфейсу приложения и никак не связаны с его
бизнес-логикой. Это скорее транспортный шлюз, который принимает запросы, валидирует их, передает в бизнес-логику и
возвращает ответ.

#### service/business

В этой папке хранятся файлы, которые относятся к бизнес-логике приложения. В моем примере внутри этой папки есть три
папки:

- core - папка с файлами, которые относятся к ядру бизнес-логики. В этой папке хранятся файлы с сущностями, которые
  описывают бизнес-логику приложения. Здесь не должны находится вспомогательные файлы, которые не относятся к
  бизнес-логике.
- data - папка с файлами, которые относятся к работе с данными. В этой папке хранятся файлы с репозиториями, которые
  отвечают за работу с базой данных. Здесь не должны находится вспомогательные файлы, которые не относятся к работе с
  данными. Здесь также могут находиться файлы с сервисами, которые отвечают за работу с внешними сервисами. Например,
  если сервис агрегирует данные из нескольких внешних сервисов, то файлы с доступом к этим сервисам должны находиться в
  этой папке, а использовать их должна бизнес-логика.
- system - папка с файлами, которые относятся к системным вещам. Я обычно держу здесь файлы с мидлварами, которые не
  относятся к бизнес-логике. Например, если вам нужно логировать все запросы к сервису, то файл с мидлваром, который
  отвечает за логирование, должен находиться в этой папке. Также здесь могут находиться файлы с вспомогательными
  функциями, которые не относятся к бизнес-логике.

#### service/deploy

В этой папке хранятся файлы, которые относятся к деплою данного сервиса. Как правило, я ограничиваюсь
файлом `Dockerfile`. В нем я описываю все необходимые для запуска сервиса шаги. Все остальное я делаю
через `docker-compose` и `Makefile` на уровне проекта.

### tools

В этой папке хранятся файлы, которые относятся к инструментам проекта. Это могут быть файлы с генераторами кода,
административные приложения или же форматтеры логов. Все что может вам помочь в разработке, но не относится к коду
самого проекта должно быть в этой папке.

### web (необязательно)

Иногда в требованиях к проекту есть необходимость создать административную панель. В этом случае я создаю папку `web` и
создаю в ней вспомогательное веб приложение. Это может быть что угодно на ваше усмотрение. Как правило, я
использую [vite](https://vitejs.dev/) с Реактом под капотом.

В папке также имеются папки `deploy` и `public`, которые аналогичны папкам с такими же названиями в папке `services`.

Все вышеуказанные папки внутри папки `web` определены для примера и могут быть изменены в зависимости от проекта.

## Makefile

В корне проекта находится файл `Makefile`, который содержит все необходимые команды для работы с проектом. Все команды в
этом файле разделены на две группы: `dev` и `prod`. Команды из группы `dev` предназначены для работы с проектом во время
разработки, а команды из группы `prod` предназначены для работы с проектом в продакшене. Все команды из группы `prod`
используются только в CI/CD, а команды из группы `dev` используются только во время разработки.

Как правило, в группе `dev` находятся команды для запуска проекта, а в группе `prod` находятся команды для деплоя. Вот
пример из файла `Makefile` одного из моих тестовых проектов:

```makefile
dev-swarm-up: build
	docker swarm init

	docker stack deploy -c ./deploy/portainer-stack.yml portainer

    docker plugin install grafana/loki-docker-driver:latest --alias loki --grant-all-permissions
	docker config create loki_config ./deploy/loki-config.yml
	docker stack deploy -c ./deploy/grafana-loki-stack.yml loki

	docker stack deploy -c ./deploy/app-stack.yml app
	...
.PHONY: swarm-up
```

В этом примере я инициализирую Docker Swarm и деплою несколько сервисов. Все команды из группы `prod` должны быть в
формате `prod-<command>`, а все команды из группы `dev` должны быть в формате `dev-<command>`.

## Заключение

В этой статье я описал свой подход к структуре проекта. Я не утверждаю, что это единственно правильный подход, но он мне
подходит, пока не появятся какие-то новые требования. Если у вас есть какие-то идеи по улучшению данного подхода, то
пишите в комментариях. Я с удовольствием выслушаю ваши идеи и, возможно, добавлю их в свой подход и буду использовать в
своих проектах.
